<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selecionar Mês e Ano</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/locales/bootstrap-datepicker.pt-BR.min.js"></script>
</head>

<body>
    <div class="container">
        <h2 class="my-4">Selecionar Mês e Ano</h2>
        <div class="form-group">
            <label for="mesAno">Mês e Ano Selecionado:</label>
            <input type="text" class="form-control" id="mesAno" name="mesAno" placeholder="Selecione o mês e ano">
        </div>
        
        <div id="tabelaDespesas" class="mt-4">
            <!-- A tabela de despesas será carregada aqui -->
        </div>
        
        <!-- <div class="total">
            <div class="container totalContainer">
            </div>
        </div> -->
    </div>






    <!-- Modal -->
    <div class="modal fade" id="editDespesaModal" tabindex="-1" role="dialog" aria-labelledby="editDespesaModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editDespesaModalLabel">Editar Despesa</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="editDespesaForm">

                        <div class="form-group">
                            <label for="editDescricao">Despesa:</label>
                            <input type="text" class="form-control" id="editDescricao" name="descricao">
                        </div>

                        <div class="form-group">
                            <label for="editValor">Valor:</label>
                            <input type="text" class="form-control" id="editValor" name="valor">
                        </div>


                        <div class="form-group">
                            <label for="editData">Data:</label>
                            <input type="text" class="form-control" id="editData" name="data">
                        </div>

                        <div class="form-group">
                            <label for="editParcela">Parcela:</label>
                            <input type="text" class="form-control" id="editParcela" name="parcela">
                        </div>
  <!---->
                        <div class="form-group">
                            <label for="editOcorrencia">Ocorrencia:</label>
                            <input type="text" class="form-control" id="editOcorrencia" name="ocorrencia">
                        </div>

                        <div class="form-group">
                            <label for="editSelectDescricao">Descrição:</label>
                            <!-- <input type="text" class="form-control" id="editSelectDescricao" name="descricao"> -->
                            <div id="editSelectDescricao"></div>
                        </div>


                        <div class="form-group">
                            <label for="editSelectCategoria">Categoria:</label>
                            <!-- <input type="text" class="form-control" id="editSelectCategoria" name="categoria"> -->
                            <div id="editSelectCategoria"></div>
                        </div>


                        <div class="form-group">
                            <label for="editVencimento">Vencimento:</label>
                            <input type="text" class="form-control" id="editVencimento" name="vencimento">
                        </div>

                        <div class="form-group">
                            <label for="editPago">Pago:</label>
                            <input type="text" class="form-control" id="editPago" name="pago">
                        </div>


                        <div class="form-group">
                            <label for="editObs">Obs:</label>
                            <input type="text" class="form-control" id="editObs" name="obs">
                        </div>

                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="flexSwitchCheckDefault" >
                            <label class="form-check-label" for="flexSwitchCheckDefault">Ativo</label>
                        </div>



                        <input type="hidden" id="despesaId" name="despesaId">
                        <button type="submit" class="btn btn-primary">Salvar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>






    <script>
        var id_despesa = undefined;
        var ocorrencia = undefined;

        $(document).ready(function(){
            $('#mesAno').datepicker({
                format: "mm/yyyy",
                startView: "months",
                minViewMode: "months",
                language: "pt-BR",
                autoclose: true,
                todayHighlight: true
            }).on('changeDate', function(e) {
                var selectedDate = $('#mesAno').val();

                let temp = selectedDate.split('/');
                selectedDate = "" + temp[1].substring(2) + "" + temp[0];
                ocorrencia = selectedDate;

                
                $.ajax({
                    url: 'modal_principal.php',       /////////////////////////////  antigo    get_despesas4.php 
                    type: 'GET',
                    data: { mesAno: selectedDate },
                    success: function(response) {
                        var resp = JSON.parse(response);
                        console.log(resp.subtotal)

                        let totais = resp.subtotal;
                        let totaisNomeAbv = resp.nomeAbv;
                        // for(let total in totais) {
                        //     let row = document.createElement('div');
                        //     row.classList.add('row')
                        //     let div = document.createElement('div');
                        //     div.classList.add('col-3');
                        //     div.appendChild(document.createTextNode(totaisNomeAbv[total] != undefined? totaisNomeAbv[total] : 'Total'));
                        //     let div2 = document.createElement('div');
                        //     div2.classList.add('col-9');
                        //     div2.appendChild(document.createTextNode(totais[total]));
                            
                        //     row.appendChild(div);
                        //     row.appendChild(div2)

                        //     $('.totalContainer').append(row);
                        //     // $('.totalrow').append(div);
                        //     // $('.totalrow').append(div2);
                        // }


                        $('#tabelaDespesas').html(resp.tabela);
                        // Adicionar o evento de clique para os botões de editar
                        $('.btn-edit').on('click', function() {
                            var despesaId = $(this).data('id');
                            var index = $(this).data('index');
                            id_despesa = despesaId;
                            // Aqui fazemos a requisição para obter os dados da despesa
                            $.ajax({
                                url: 'modal_edita_detalhe.php',       /////////////////////////////  antigo    get_despesa2.php 
                                type: 'GET',
                                data: { id: despesaId },
                                success: function(data) {
                                    var despesa = JSON.parse(data);
                                    console.log(despesa)
                                    $('#editDescricao').val(despesa.despesa);
                                    $('#editValor').val(despesa.valor);
                                    $('#despesaId').val(despesa.id_despesa);
                                    $('#editParcela').val(despesa.parcela);
                                    $('#editOcorrencia').val(despesa.ocorrencia);
                                    $('#editSelectDescricao').html(resp.select[index]);
                                    $('#editSelectCategoria').html(resp.categoria[index]);
                                    $('#editData').val(dateFormat(despesa.data)); 
                                    $('#editValor').val(despesa.valor);
                                    $('#editParcela').val(despesa.parcela);
                                    $('#editVencimento').val(dateFormat(despesa.vencimento));
                                    $('#editPago').val(dateFormat(despesa.pago));
                                    $('#editObs').val(despesa.obs);
                                    $('#flexSwitchCheckDefault').prop('checked' , true)//(despesa.valido == "S" || despesa.valido == "s"))

                                    $('#editDespesaModal').modal('show');
                                }
                            });
                        });
                    },
                    error: function() {
                        $('#tabelaDespesas').html('<p>Ocorreu um erro ao carregar as despesas.</p>');
                    }
                });
            });

            $('#editDespesaForm').on('submit', (event) => {
                event.preventDefault();
                var despesa = {};

                despesa.id_despesa =  id_despesa;
                despesa.despesa = event.target[0].value;
                despesa.valor = event.target[1].value;

                despesa.ocorrencia = ocorrencia;
                despesa.data = dateDesformat(event.target[2].value);
                despesa.parcela = event.target[3].value;
                despesa.ocorrencia = event.target[4].value;
                despesa.id_descricao = event.target[5].value;
                despesa.categoria = event.target[6].value;
                despesa.vencimento = dateDesformat(event.target[7].value);
                despesa.pago = dateDesformat(event.target[8].value);
                despesa.obs = event.target[9].value;

                despesa.valor_casa = '';
                despesa.valido = event.target[10].checked ? 'S' : 'N';

                console.log('despesa', despesa);

                $.ajax({
                    url: 'save_despesa.php',   /////////////////////////////  antigo    save_despesa.php  
                    type: 'POST',
                    data: despesa,
                    success: (result) => {
                        console.log(result)
                        alert(result);
                        $('#editDespesaModal').modal('hide');
                        $('#mesAno').datepicker('update');
                    },
                    error: () => {

                    }
                })
            })
        });

        function dateFormat(date) {
            let datasplit = date.split('-')
            return `${datasplit[2]}/${datasplit[1]}/${datasplit[0]}`;
        }

        function dateDesformat(date) {
            let datasplit = date.split('/');
            return `${datasplit[2]}-${datasplit[1]}-${datasplit[0]}`;
        }

    </script>
</body>
</html>
